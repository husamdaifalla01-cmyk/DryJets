# DryJets Production Deployment Master Guide
## Free-First Strategy for Zero-Experience Users

> **This guide was automatically generated by Claude Code for the DryJets Marketing Engine & Offer-Lab system.**
>
> It covers deployment, testing, validation, and production stabilization â€” all using free-tier infrastructure and zero-coding knowledge required.

---

## Table of Contents

1. [Introduction](#introduction)
2. [Discovery Summary](#discovery-summary)
3. [Free-First Deployment Architecture](#free-first-deployment-architecture)
4. [Prerequisites & Account Setup](#prerequisites--account-setup)
5. [Environment Variables Setup Wizard](#environment-variables-setup-wizard)
6. [Step-by-Step Deployment](#step-by-step-deployment)
7. [10 Claude Code Deployment Prompts](#10-claude-code-deployment-prompts)
8. [Post-Deployment Validation](#post-deployment-validation)
9. [Troubleshooting Guide](#troubleshooting-guide)
10. [Long-Term Stability & Monitoring](#long-term-stability--monitoring)
11. [Cost Calculator](#cost-calculator)
12. [Glossary](#glossary)

---

## Introduction

### What This Guide Does

This guide will take you from **local development â†’ live production** in ~2-3 hours using **free or near-free cloud services**. You'll deploy:

- âœ… **4 Next.js frontend apps** (marketing-admin, web-platform, customer, merchant)
- âœ… **1 NestJS backend API** (with 16 modules, 125+ services)
- âœ… **PostgreSQL database** (103 models, full schema)
- âœ… **Redis cache** (sessions, job queues)
- âœ… **Complete Offer-Lab system** (affiliate marketing automation)
- âœ… **Monitoring & alerts** (uptime, errors, performance)

### Who This Is For

- âœ… Entrepreneurs with **zero coding experience**
- âœ… Founders who want their MVP **live fast**
- âœ… Anyone who wants to **avoid expensive AWS bills**
- âœ… Teams looking for **copy-paste deployment**

### Time Estimates

| Phase | Time Required | Difficulty |
|-------|--------------|------------|
| Prerequisites & Account Setup | 30 minutes | Easy |
| Environment Variables | 45 minutes | Medium |
| Database Deployment | 15 minutes | Easy |
| Backend API Deployment | 30 minutes | Medium |
| Frontend Deployment | 20 minutes | Easy |
| Testing & Validation | 20 minutes | Easy |
| Monitoring Setup | 15 minutes | Easy |
| **TOTAL** | **~2-3 hours** | **Beginner-Friendly** |

---

## Discovery Summary

### Repository Structure

```
DryJets/
â”œâ”€â”€ apps/                          # 9 Applications
â”‚   â”œâ”€â”€ api/                       # NestJS Backend (port 4000)
â”‚   â”œâ”€â”€ marketing-admin/           # Marketing Dashboard (port 3004)
â”‚   â”œâ”€â”€ web-platform/              # Unified Platform (port 3000)
â”‚   â”œâ”€â”€ web-customer/              # Customer Portal (port 3001)
â”‚   â”œâ”€â”€ web-merchant/              # Merchant Portal (port 3002)
â”‚   â”œâ”€â”€ web-admin/                 # Admin Dashboard (skeleton)
â”‚   â”œâ”€â”€ mobile-customer/           # React Native Customer App
â”‚   â”œâ”€â”€ mobile-driver/             # React Native Driver App
â”‚   â””â”€â”€ desktop/                   # Electron Desktop App (skeleton)
â”‚
â”œâ”€â”€ packages/                      # 8 Shared Packages
â”‚   â”œâ”€â”€ database/                  # Prisma ORM (103 models)
â”‚   â”œâ”€â”€ api-client/                # Type-safe API client
â”‚   â”œâ”€â”€ types/                     # Shared TypeScript types
â”‚   â”œâ”€â”€ config/                    # Shared configurations
â”‚   â”œâ”€â”€ ui/                        # Shared UI components
â”‚   â”œâ”€â”€ hooks/                     # React hooks
â”‚   â”œâ”€â”€ storage/                   # Storage utilities
â”‚   â””â”€â”€ utils/                     # Utilities
â”‚
â”œâ”€â”€ docs/                          # 25 Documentation Directories
â”œâ”€â”€ infrastructure/                # Docker & K8s configs
â”œâ”€â”€ scripts/                       # Automation scripts
â””â”€â”€ tests/                         # Test suites
```

### Technology Stack

| Component | Technology | Version | Purpose |
|-----------|-----------|---------|---------|
| **Backend** | NestJS | 10.3.0 | REST API, GraphQL, WebSockets |
| **Frontend** | Next.js | 14.2.0 | Server-side rendered React apps |
| **Database** | PostgreSQL | 15+ | Primary data store |
| **Cache** | Redis | 7+ | Sessions, job queues, caching |
| **ORM** | Prisma | 5.22.0 | Type-safe database access |
| **Monorepo** | Turborepo | 2.0.0 | Build orchestration |
| **Package Manager** | npm | 10.8.1 | Dependency management |
| **Node.js** | Node | 20+ | JavaScript runtime |

### Database Models Overview

**103 Total Models** organized by domain:

- **Core Platform** (33 models): Users, Orders, Services, Payments, Reviews
- **Enterprise** (5 models): Business Accounts, Branches, Subscriptions
- **IoT** (4 models): Equipment, Telemetry, Maintenance Alerts
- **Marketing Engine** (65 models): Campaigns, Content, SEO, Analytics, Video, Workflows
- **Offer-Lab** (17 models): Offers, Funnels, Lead Magnets, Traffic, Ad Campaigns

### API Modules (16 Total)

Located in [apps/api/src/modules/](../../apps/api/src/modules/):

1. **analytics** - Analytics and tracking
2. **auth** - Authentication & JWT
3. **business-accounts** - Corporate clients
4. **drivers** - Driver operations
5. **enterprise** - Multi-location enterprises
6. **events** - Event handling
7. **invoices** - Invoice management
8. **iot** - IoT equipment integration
9. **marketing** - AI Marketing Engine (14 controllers, 125+ services)
10. **merchants** - Merchant operations
11. **notifications** - Push/SMS/Email
12. **orders** - Order processing
13. **payments** - Stripe payment processing
14. **users** - User management
15. **real-time** - Socket.io WebSockets
16. **files** - File uploads/downloads

### Marketing Engine Capabilities

The Marketing Engine includes:

- **Offer-Lab** (50+ endpoints): Affiliate marketing automation, funnel generation, traffic deployment
- **AI Content Generation**: Claude for long-form content, GPT-4 for ads
- **SEO Automation**: Programmatic page generation, keyword clustering, SERP tracking
- **Video Production**: Script generation, metadata optimization, Video DNA profiles
- **Multi-Platform Publishing**: LinkedIn, YouTube, TikTok, Twitter, Facebook, Instagram
- **ML Intelligence**: Trend forecasting, performance prediction, A/B testing
- **Optimization**: Budget optimization, ROI prediction, traffic quality scoring

---

## Free-First Deployment Architecture

### Overview Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLOUDFLARE (Free Tier)                   â”‚
â”‚              DNS + SSL + CDN + DDoS Protection               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                          â”‚
        â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VERCEL (Free)  â”‚                    â”‚  RAILWAY (Free $5)  â”‚
â”‚                 â”‚                    â”‚                     â”‚
â”‚ â€¢ marketing-    â”‚â—„â”€â”€â”€â”€â”€â”€â”€APIâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â€¢ NestJS API        â”‚
â”‚   admin         â”‚     Calls          â”‚ â€¢ PostgreSQL        â”‚
â”‚ â€¢ web-platform  â”‚                    â”‚ â€¢ Redis             â”‚
â”‚ â€¢ web-customer  â”‚                    â”‚                     â”‚
â”‚ â€¢ web-merchant  â”‚                    â”‚ Auto-deploy from    â”‚
â”‚                 â”‚                    â”‚ GitHub pushes       â”‚
â”‚ Auto-deploy     â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ from GitHub     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CLOUDFLARE R2 (Free 10GB/month)                 â”‚
â”‚                  File Storage + CDN                          â”‚
â”‚          (Alternative: AWS S3 or Backblaze B2)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MONITORING (All Free)                      â”‚
â”‚  â€¢ UptimeRobot (50 monitors free)                            â”‚
â”‚  â€¢ Sentry (5K errors/month free)                             â”‚
â”‚  â€¢ GitHub Actions (2000 min/month free)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Service Selection Rationale

#### Frontend: Vercel (Free Tier)

**Why Vercel:**
- âœ… **Free tier** includes:
  - 100GB bandwidth/month
  - Automatic HTTPS
  - Global CDN
  - GitHub integration (auto-deploy on push)
  - Environment variables UI
  - Preview deployments for PRs
- âœ… **Perfect for Next.js** (built by the Next.js team)
- âœ… **Zero configuration** needed
- âœ… **Upgrade path** available if needed

**Alternatives:**
- **Netlify** (similar free tier, also excellent)
- **Cloudflare Pages** (unlimited bandwidth, but newer)

#### Backend: Railway (Free $5 Credit/Month)

**Why Railway:**
- âœ… **$5 free credit/month** (enough for MVP)
- âœ… **PostgreSQL included** (1GB free)
- âœ… **Redis included** (free addon)
- âœ… **GitHub integration** (auto-deploy)
- âœ… **Easy environment variables** management
- âœ… **Automatic backups** included
- âœ… **No credit card** required for trial

**Alternatives:**
- **Render** ($7/month after free trial, but more generous free tier)
- **Fly.io** (complex pricing, better for scale)
- **Heroku** (discontinued free tier)

#### Database: Railway PostgreSQL

**Why Railway PostgreSQL:**
- âœ… **1GB storage free** (included in Railway)
- âœ… **Automatic backups** (daily)
- âœ… **Connection pooling** available
- âœ… **Same platform** as API (low latency)

**Alternatives:**
- **Neon** (serverless PostgreSQL, generous free tier)
- **Supabase** (3GB free, includes auth)
- **AWS RDS Free Tier** (1 year, then expensive)

#### File Storage: Cloudflare R2

**Why Cloudflare R2:**
- âœ… **10GB free/month**
- âœ… **S3-compatible** (drop-in replacement)
- âœ… **No egress fees** (huge savings vs S3)
- âœ… **Global CDN** included

**Alternatives:**
- **AWS S3** (5GB free for 12 months, then paid)
- **Backblaze B2** (10GB free, cheaper than S3)
- **DigitalOcean Spaces** ($5/month, 250GB)

#### Monitoring: UptimeRobot + Sentry

**Why UptimeRobot:**
- âœ… **50 monitors free**
- âœ… **5-minute intervals**
- âœ… **Email/SMS alerts**

**Why Sentry:**
- âœ… **5,000 errors/month free**
- âœ… **Already integrated** in codebase
- âœ… **Source maps** support
- âœ… **Performance monitoring** included

---

## Prerequisites & Account Setup

### Required Accounts (All Free to Start)

| Service | Free Tier | Credit Card Required | Time to Setup |
|---------|-----------|---------------------|---------------|
| [GitHub](https://github.com) | âœ… Unlimited public repos | âŒ No | 5 min |
| [Vercel](https://vercel.com) | âœ… 100GB bandwidth | âŒ No | 5 min |
| [Railway](https://railway.app) | âœ… $5 credit/month | âœ… Yes (after trial) | 5 min |
| [Cloudflare](https://cloudflare.com) | âœ… Free plan forever | âŒ No | 10 min |
| [SendGrid](https://sendgrid.com) | âœ… 100 emails/day | âœ… Yes | 10 min |
| [Twilio](https://twilio.com) | âœ… Trial credit | âœ… Yes | 10 min |
| [Stripe](https://stripe.com) | âœ… Test mode | âœ… Yes (for live) | 10 min |
| [UptimeRobot](https://uptimerobot.com) | âœ… 50 monitors | âŒ No | 5 min |
| [Sentry](https://sentry.io) | âœ… 5K errors/month | âŒ No | 5 min |

### Optional Accounts (For Full Features)

| Service | Purpose | Free Tier | Time |
|---------|---------|-----------|------|
| [Anthropic](https://console.anthropic.com) | Claude AI (Offer-Lab) | âŒ Pay-per-use | 5 min |
| [OpenAI](https://platform.openai.com) | GPT-4 (ad copy) | âŒ Pay-per-use | 5 min |
| [Google Cloud](https://console.cloud.google.com) | Maps API | âœ… $200 credit | 15 min |

### Step-by-Step Account Setup

#### 1. GitHub Account (Required)

1. Go to [github.com](https://github.com)
2. Click "Sign up"
3. Enter email, password, username
4. Verify email
5. **Important:** Make sure your DryJets code is pushed to a GitHub repository

**Test:** Visit `https://github.com/YOUR_USERNAME/DryJets` and confirm you can see the code.

---

#### 2. Vercel Account (Required)

1. Go to [vercel.com](https://vercel.com)
2. Click "Sign Up"
3. **Select "Continue with GitHub"** (recommended)
4. Authorize Vercel to access your GitHub
5. You'll see the Vercel dashboard

**Test:** You should see "Import Project" button on dashboard.

---

#### 3. Railway Account (Required)

1. Go to [railway.app](https://railway.app)
2. Click "Login" (top right)
3. **Select "Login with GitHub"** (recommended)
4. Authorize Railway
5. You'll get **$5 free credit/month**
6. After trial ends, add a credit card to continue (they'll ask)

**Test:** You should see "New Project" button on dashboard.

---

#### 4. Cloudflare Account (Optional but Recommended)

1. Go to [cloudflare.com](https://cloudflare.com)
2. Click "Sign Up"
3. Enter email and password
4. Verify email
5. Free plan is automatically selected

**Test:** You should see "Add a Site" button.

---

#### 5. SendGrid Account (Required for Email)

1. Go to [sendgrid.com](https://sendgrid.com)
2. Click "Start for Free"
3. Fill in account details
4. **Verify your email** (critical!)
5. Complete identity verification (upload ID if needed)
6. Create an API key:
   - Go to Settings â†’ API Keys
   - Click "Create API Key"
   - Name: `dryjets-production`
   - Permissions: **Full Access**
   - Copy the key (you won't see it again!)

**Test:** Save API key in a secure note. It starts with `SG.`

---

#### 6. Twilio Account (Required for SMS)

1. Go to [twilio.com](https://twilio.com)
2. Click "Sign up and start building"
3. Fill in details
4. Verify phone number
5. You'll get **trial credit** (~$15)
6. Go to Console:
   - Copy **Account SID**
   - Copy **Auth Token**
   - Get a phone number: Phone Numbers â†’ Buy a Number
   - Copy the phone number (format: +1234567890)

**Test:** Save SID, Token, and Phone Number in a secure note.

---

#### 7. Stripe Account (Required for Payments)

1. Go to [stripe.com](https://stripe.com)
2. Click "Start now"
3. Create account
4. **Stay in Test Mode** for now (toggle in top right)
5. Get your API keys:
   - Go to Developers â†’ API Keys
   - Copy **Publishable Key** (starts with `pk_test_`)
   - Copy **Secret Key** (starts with `sk_test_`)
6. Set up webhooks (we'll do this after deployment)

**Test:** Save both keys in a secure note.

---

#### 8. UptimeRobot Account (Optional)

1. Go to [uptimerobot.com](https://uptimerobot.com)
2. Sign up (free forever)
3. Verify email
4. You can create monitors after deployment

---

#### 9. Sentry Account (Optional but Recommended)

1. Go to [sentry.io](https://sentry.io)
2. Sign up with GitHub
3. Create a project:
   - Platform: **Node.js**
   - Name: `dryjets-api`
4. Copy the **DSN** (starts with `https://`)
5. Create another project:
   - Platform: **Next.js**
   - Name: `dryjets-marketing-admin`
6. Copy the DSN

**Test:** Save both DSNs in a secure note.

---

### Checklist Before Moving Forward

- [ ] GitHub account created and DryJets code is in a repository
- [ ] Vercel account connected to GitHub
- [ ] Railway account created
- [ ] SendGrid API key saved
- [ ] Twilio SID, Token, and Phone Number saved
- [ ] Stripe test keys saved
- [ ] (Optional) Sentry DSNs saved
- [ ] (Optional) UptimeRobot account created

---

## Environment Variables Setup Wizard

### What Are Environment Variables?

Environment variables are **configuration settings** that your app needs to run. Think of them as:

- ðŸ”‘ **Passwords** for external services (Stripe, SendGrid)
- ðŸŒ **URLs** to connect services together
- ðŸŽ›ï¸ **Settings** to control app behavior

### Variable Categories

We have **50+ environment variables**. Here they are organized by category:

---

### 1ï¸âƒ£ Database Configuration (REQUIRED)

| Variable | Example | Where to Get It | Required? |
|----------|---------|-----------------|-----------|
| `DATABASE_URL` | `postgresql://user:pass@host:5432/db` | Railway (auto-generated) | âœ… YES |
| `REDIS_URL` | `redis://default:pass@host:6379` | Railway (auto-generated) | âœ… YES |

**How to get these:**
1. After creating Railway project (see deployment section)
2. Railway will auto-generate these values
3. Copy them from Railway Variables tab

---

### 2ï¸âƒ£ API Configuration (REQUIRED)

| Variable | Value | Explanation | Required? |
|----------|-------|-------------|-----------|
| `NODE_ENV` | `production` | Tells app it's in production mode | âœ… YES |
| `PORT` | `4000` | Port for API (Railway auto-assigns, use theirs) | âœ… YES |
| `CORS_ORIGIN` | `https://yourapp.vercel.app` | Allowed frontend domains (comma-separated) | âœ… YES |

**For CORS_ORIGIN:**
After deploying frontends to Vercel, you'll have URLs like:
```
https://marketing-admin-dryjets.vercel.app,https://customer-dryjets.vercel.app,https://merchant-dryjets.vercel.app
```

---

### 3ï¸âƒ£ Security & Authentication (REQUIRED)

| Variable | How to Generate | Required? |
|----------|-----------------|-----------|
| `JWT_SECRET` | `openssl rand -base64 32` | âœ… YES |
| `JWT_EXPIRES_IN` | `7d` | âœ… YES |
| `JWT_REFRESH_SECRET` | `openssl rand -base64 32` (different from above) | âœ… YES |
| `JWT_REFRESH_EXPIRES_IN` | `30d` | âœ… YES |

**How to generate secrets on Mac:**
```bash
# Open Terminal and run:
openssl rand -base64 32

# Example output:
# K8x9Y2mP5qR7tW3vU6nM1kL4jH8gF5dS2aZ9cX7bV0

# Run it TWICE to get two different secrets
```

---

### 4ï¸âƒ£ Stripe Payments (REQUIRED)

| Variable | Where to Get It | Format |
|----------|-----------------|--------|
| `STRIPE_SECRET_KEY` | Stripe Dashboard â†’ API Keys | `sk_test_...` (test) or `sk_live_...` (live) |
| `STRIPE_PUBLISHABLE_KEY` | Stripe Dashboard â†’ API Keys | `pk_test_...` (test) or `pk_live_...` (live) |
| `STRIPE_WEBHOOK_SECRET` | Stripe Dashboard â†’ Webhooks | `whsec_...` (we'll set this up later) |
| `STRIPE_CONNECT_CLIENT_ID` | Stripe Dashboard â†’ Connect Settings | `ca_...` |

**For now:** Use **test mode** keys (start with `sk_test_` and `pk_test_`)

---

### 5ï¸âƒ£ Email (SendGrid) - REQUIRED

| Variable | Where to Get It |
|----------|-----------------|
| `SENDGRID_API_KEY` | SendGrid â†’ Settings â†’ API Keys |
| `SENDGRID_FROM_EMAIL` | Your verified sender email (e.g., `noreply@yourdomain.com`) |

**Important:** You must verify your sender email in SendGrid before sending emails.

---

### 6ï¸âƒ£ SMS (Twilio) - REQUIRED

| Variable | Where to Get It |
|----------|-----------------|
| `TWILIO_ACCOUNT_SID` | Twilio Console (starts with `AC...`) |
| `TWILIO_AUTH_TOKEN` | Twilio Console (long random string) |
| `TWILIO_PHONE_NUMBER` | Twilio â†’ Phone Numbers (format: `+1234567890`) |

---

### 7ï¸âƒ£ File Storage (Cloudflare R2 or AWS S3)

**Option A: Cloudflare R2 (Recommended - Free 10GB)**

| Variable | Where to Get It |
|----------|-----------------|
| `AWS_REGION` | `auto` (for R2) |
| `AWS_ACCESS_KEY_ID` | Cloudflare â†’ R2 â†’ Manage R2 API Tokens |
| `AWS_SECRET_ACCESS_KEY` | Cloudflare â†’ R2 â†’ Manage R2 API Tokens |
| `AWS_S3_BUCKET` | Your R2 bucket name (e.g., `dryjets-uploads`) |
| `AWS_S3_ENDPOINT` | R2 endpoint (e.g., `https://[account-id].r2.cloudflarestorage.com`) |

**Option B: AWS S3 (Alternative)**

| Variable | Where to Get It |
|----------|-----------------|
| `AWS_REGION` | `us-east-1` (or your chosen region) |
| `AWS_ACCESS_KEY_ID` | AWS IAM â†’ Create Access Key |
| `AWS_SECRET_ACCESS_KEY` | AWS IAM â†’ Create Access Key |
| `AWS_S3_BUCKET` | Your S3 bucket name |

---

### 8ï¸âƒ£ Google Maps (REQUIRED)

| Variable | Where to Get It |
|----------|-----------------|
| `GOOGLE_MAPS_API_KEY` | Google Cloud Console â†’ APIs â†’ Credentials |

**Steps to get Google Maps API Key:**
1. Go to [console.cloud.google.com](https://console.cloud.google.com)
2. Create a new project (or select existing)
3. Enable these APIs:
   - Maps JavaScript API
   - Geocoding API
   - Places API
4. Go to Credentials â†’ Create Credentials â†’ API Key
5. **Restrict the key:**
   - HTTP referrers: Add your domain
   - API restrictions: Select the 3 APIs above
6. Copy the key

---

### 9ï¸âƒ£ AI Services (OPTIONAL - for Offer-Lab)

| Variable | Where to Get It | Cost |
|----------|-----------------|------|
| `ANTHROPIC_API_KEY` | [console.anthropic.com](https://console.anthropic.com) â†’ API Keys | ~$0.01/request |
| `OPENAI_API_KEY` | [platform.openai.com](https://platform.openai.com) â†’ API Keys | ~$0.002/request |

**When you need these:**
- Only if using **Offer-Lab** (affiliate marketing automation)
- You can skip for now and add later

---

### ðŸ”Ÿ Offer-Lab Specific (OPTIONAL)

| Variable | Value | Explanation |
|----------|-------|-------------|
| `OFFERLAB_ENCRYPTION_KEY` | Generate with: `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"` | Encrypts affiliate credentials |
| `OFFERLAB_SANDBOX_MODE` | `true` (dev) or `false` (prod) | Sandbox mode for testing |
| `OFFERLAB_GLOBAL_BUDGET_CAP` | `300` | Max daily budget in USD |
| `OFFERLAB_DEFAULT_TEST_BUDGET` | `5` | Default test campaign budget |

---

### 1ï¸âƒ£1ï¸âƒ£ Frontend URLs (REQUIRED)

These are set **AFTER** you deploy frontends. Leave blank for now.

| Variable | Example |
|----------|---------|
| `NEXT_PUBLIC_API_URL` | `https://dryjets-api.railway.app` |
| `NEXT_PUBLIC_WEB_MERCHANT_URL` | `https://merchant-dryjets.vercel.app` |
| `NEXT_PUBLIC_WEB_ADMIN_URL` | `https://admin-dryjets.vercel.app` |

---

### 1ï¸âƒ£2ï¸âƒ£ Monitoring (OPTIONAL)

| Variable | Where to Get It |
|----------|-----------------|
| `SENTRY_DSN` | Sentry â†’ Project Settings â†’ Client Keys (DSN) |

---

### Environment Variables Checklist

**Before deploying, gather these:**

**CRITICAL (App won't start without these):**
- [ ] `DATABASE_URL` (from Railway)
- [ ] `REDIS_URL` (from Railway)
- [ ] `JWT_SECRET` (generate with openssl)
- [ ] `JWT_REFRESH_SECRET` (generate with openssl)

**REQUIRED for Core Features:**
- [ ] `STRIPE_SECRET_KEY` (Stripe dashboard)
- [ ] `STRIPE_PUBLISHABLE_KEY` (Stripe dashboard)
- [ ] `SENDGRID_API_KEY` (SendGrid)
- [ ] `SENDGRID_FROM_EMAIL` (your email)
- [ ] `TWILIO_ACCOUNT_SID` (Twilio)
- [ ] `TWILIO_AUTH_TOKEN` (Twilio)
- [ ] `TWILIO_PHONE_NUMBER` (Twilio)
- [ ] `GOOGLE_MAPS_API_KEY` (Google Cloud)
- [ ] `AWS_ACCESS_KEY_ID` (R2 or S3)
- [ ] `AWS_SECRET_ACCESS_KEY` (R2 or S3)
- [ ] `AWS_S3_BUCKET` (R2 or S3)

**OPTIONAL (Add Later):**
- [ ] `ANTHROPIC_API_KEY` (for Offer-Lab AI)
- [ ] `OPENAI_API_KEY` (for Offer-Lab AI)
- [ ] `SENTRY_DSN` (for error tracking)

---

## Step-by-Step Deployment

### Phase 1: Deploy Database (Railway)

**Time:** ~15 minutes

#### Step 1.1: Create Railway Project

1. Go to [railway.app](https://railway.app)
2. Click "New Project"
3. Select "Provision PostgreSQL"
4. Railway creates a PostgreSQL database instantly
5. You'll see the database in your project

#### Step 1.2: Add Redis

1. In the same Railway project, click "New"
2. Select "Database" â†’ "Add Redis"
3. Railway provisions Redis

#### Step 1.3: Get Database URLs

1. Click on the **PostgreSQL** service
2. Go to "Variables" tab
3. Find `DATABASE_URL` - it looks like:
   ```
   postgresql://postgres:[password]@[host].railway.app:5432/railway
   ```
4. **Copy this entire URL** - save it in a note

5. Click on the **Redis** service
6. Go to "Variables" tab
7. Find `REDIS_URL` - it looks like:
   ```
   redis://default:[password]@[host].railway.app:6379
   ```
8. **Copy this entire URL** - save it in a note

**âœ… Checkpoint:** You should now have two URLs saved.

---

### Phase 2: Deploy Backend API (Railway)

**Time:** ~30 minutes

#### Step 2.1: Create API Service

1. In your Railway project, click "New"
2. Select "GitHub Repo"
3. Select your `DryJets` repository
4. Railway will detect it's a monorepo

#### Step 2.2: Configure Build Settings

1. Click on the newly created service
2. Go to "Settings" tab
3. **Root Directory:** `/apps/api`
4. **Build Command:** `npm run build`
5. **Start Command:** `npm run start:prod`
6. **Watch Paths:** `/apps/api/**`, `/packages/**`

#### Step 2.3: Set Environment Variables

1. Go to "Variables" tab
2. Click "Raw Editor"
3. Paste the following (replace values with your actual ones):

```bash
# Database (auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}
REDIS_URL=${{Redis.REDIS_URL}}

# API Configuration
NODE_ENV=production
PORT=4000

# Security (GENERATE THESE!)
JWT_SECRET=YOUR_GENERATED_SECRET_HERE
JWT_EXPIRES_IN=7d
JWT_REFRESH_SECRET=YOUR_SECOND_GENERATED_SECRET_HERE
JWT_REFRESH_EXPIRES_IN=30d

# Stripe
STRIPE_SECRET_KEY=sk_test_YOUR_KEY_HERE
STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_KEY_HERE
STRIPE_WEBHOOK_SECRET=whsec_YOUR_WEBHOOK_SECRET
STRIPE_CONNECT_CLIENT_ID=ca_YOUR_CLIENT_ID

# SendGrid
SENDGRID_API_KEY=SG.YOUR_API_KEY_HERE
SENDGRID_FROM_EMAIL=noreply@yourdomain.com

# Twilio
TWILIO_ACCOUNT_SID=AC_YOUR_SID_HERE
TWILIO_AUTH_TOKEN=YOUR_AUTH_TOKEN_HERE
TWILIO_PHONE_NUMBER=+1234567890

# AWS/R2 Storage
AWS_REGION=auto
AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY
AWS_SECRET_ACCESS_KEY=YOUR_SECRET_KEY
AWS_S3_BUCKET=dryjets-uploads
AWS_S3_ENDPOINT=YOUR_R2_ENDPOINT

# Google Maps
GOOGLE_MAPS_API_KEY=YOUR_MAPS_API_KEY

# Monitoring (optional)
SENTRY_DSN=YOUR_SENTRY_DSN

# Feature Flags
ENABLE_AI_FEATURES=true
ENABLE_SUBSCRIPTIONS=true
ENABLE_REFERRALS=true

# CORS (we'll update this after deploying frontends)
CORS_ORIGIN=*
```

4. Click "Save"

**Important Note about `${{Postgres.DATABASE_URL}}`:**
This is Railway's syntax to reference variables from other services. It automatically uses the PostgreSQL URL.

#### Step 2.4: Add Prisma Generate to Build

Railway needs to generate the Prisma client during build. We need to add a build step.

1. Go to "Settings" tab
2. **Build Command:** Change to:
   ```bash
   npm install && npx prisma generate --schema=../../packages/database/prisma/schema.prisma && npm run build
   ```

#### Step 2.5: Deploy

1. Railway will automatically start deploying
2. Watch the "Deployments" tab for build logs
3. First deployment takes ~5-10 minutes
4. Look for "Build successful" message

#### Step 2.6: Run Database Migration

After first successful build:

1. Go to the API service
2. Click on the three dots (â‹®) â†’ "Open Shell"
3. Run:
   ```bash
   npx prisma migrate deploy --schema=../../packages/database/prisma/schema.prisma
   ```
4. Wait for migrations to complete

#### Step 2.7: Get API URL

1. Go to "Settings" tab
2. Under "Networking", click "Generate Domain"
3. Railway gives you a URL like: `dryjets-api-production.up.railway.app`
4. Your API is now live at: `https://dryjets-api-production.up.railway.app`

**âœ… Test Your API:**

Open in browser: `https://your-api-url.railway.app/api/docs`

You should see Swagger API documentation.

---

### Phase 3: Deploy Frontend Apps (Vercel)

**Time:** ~20 minutes per app (4 apps = ~1.5 hours, but can be done in parallel)

We'll deploy 4 Next.js apps:
1. Marketing Admin (port 3004)
2. Web Platform (port 3000)
3. Web Customer (port 3001)
4. Web Merchant (port 3002)

#### Step 3.1: Deploy Marketing Admin

1. Go to [vercel.com/new](https://vercel.com/new)
2. Click "Import Git Repository"
3. Select your `DryJets` repository
4. **Important:** Vercel detects it's a monorepo
5. Configure:
   - **Project Name:** `dryjets-marketing-admin`
   - **Framework Preset:** Next.js
   - **Root Directory:** `apps/marketing-admin`
   - **Build Command:** Leave default (`npm run build`)
   - **Output Directory:** Leave default (`.next`)

6. **Environment Variables:**
   Click "Environment Variables" and add:
   ```
   NEXT_PUBLIC_API_URL=https://your-railway-api-url.railway.app
   ```

7. Click "Deploy"
8. Wait 2-3 minutes
9. You'll get a URL like: `dryjets-marketing-admin.vercel.app`

**âœ… Test:** Visit the URL. You should see the marketing admin dashboard.

#### Step 3.2: Deploy Web Platform

Repeat the same process:
1. Go to [vercel.com/new](https://vercel.com/new)
2. Import same repository
3. Configure:
   - **Project Name:** `dryjets-platform`
   - **Root Directory:** `apps/web-platform`
4. Environment Variables:
   ```
   NEXT_PUBLIC_API_URL=https://your-railway-api-url.railway.app
   ```
5. Deploy

#### Step 3.3: Deploy Web Customer

1. Go to [vercel.com/new](https://vercel.com/new)
2. Import same repository
3. Configure:
   - **Project Name:** `dryjets-customer`
   - **Root Directory:** `apps/web-customer`
4. Environment Variables:
   ```
   NEXT_PUBLIC_API_URL=https://your-railway-api-url.railway.app
   NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_KEY
   ```
5. Deploy

#### Step 3.4: Deploy Web Merchant

1. Go to [vercel.com/new](https://vercel.com/new)
2. Import same repository
3. Configure:
   - **Project Name:** `dryjets-merchant`
   - **Root Directory:** `apps/web-merchant`
4. Environment Variables:
   ```
   NEXT_PUBLIC_API_URL=https://your-railway-api-url.railway.app
   NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_KEY
   ```
5. Deploy

#### Step 3.5: Update CORS Settings

Now that you have all frontend URLs, update the API's CORS settings:

1. Go to Railway â†’ Your API Service â†’ Variables
2. Find `CORS_ORIGIN`
3. Update to:
   ```
   https://dryjets-marketing-admin.vercel.app,https://dryjets-platform.vercel.app,https://dryjets-customer.vercel.app,https://dryjets-merchant.vercel.app
   ```
4. Save
5. Railway will automatically redeploy the API

**âœ… Checkpoint:** All 4 frontends are deployed and can communicate with the API.

---

### Phase 4: Setup Custom Domains (Optional)

**Time:** ~30 minutes

If you have a custom domain (e.g., `dryjets.com`):

#### Step 4.1: Add Domain to Vercel

For each Vercel project:
1. Go to Project Settings â†’ Domains
2. Add domain:
   - Marketing Admin: `admin.dryjets.com`
   - Platform: `app.dryjets.com`
   - Customer: `dryjets.com` or `www.dryjets.com`
   - Merchant: `merchant.dryjets.com`

#### Step 4.2: Configure DNS (Cloudflare)

1. Go to Cloudflare â†’ DNS â†’ Records
2. Add CNAME records:
   ```
   admin       CNAME    cname.vercel-dns.com
   app         CNAME    cname.vercel-dns.com
   www         CNAME    cname.vercel-dns.com
   merchant    CNAME    cname.vercel-dns.com
   ```
3. Wait 5-10 minutes for DNS propagation

#### Step 4.3: Add Domain to Railway (API)

1. Railway â†’ API Service â†’ Settings â†’ Networking
2. Click "Add Custom Domain"
3. Enter: `api.dryjets.com`
4. Railway gives you a CNAME target
5. Add CNAME in Cloudflare:
   ```
   api    CNAME    your-project.up.railway.app
   ```

**âœ… Test:** Visit your custom domains. HTTPS is automatic.

---

### Phase 5: Configure Stripe Webhooks

**Time:** ~10 minutes

Stripe needs to send events (payment success, refunds) to your API.

#### Step 5.1: Create Webhook Endpoint

1. Go to [dashboard.stripe.com](https://dashboard.stripe.com)
2. Developers â†’ Webhooks
3. Click "Add endpoint"
4. **Endpoint URL:** `https://your-api-url.railway.app/api/v1/payments/webhook`
5. **Events to send:** Select:
   - `payment_intent.succeeded`
   - `payment_intent.payment_failed`
   - `charge.refunded`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
6. Click "Add endpoint"

#### Step 5.2: Get Webhook Secret

1. After creating webhook, click on it
2. Click "Reveal" next to "Signing secret"
3. Copy the secret (starts with `whsec_`)

#### Step 5.3: Add to Railway

1. Railway â†’ API Service â†’ Variables
2. Find `STRIPE_WEBHOOK_SECRET`
3. Update with the secret you just copied
4. Save (Railway will redeploy)

**âœ… Test:** In Stripe dashboard, click "Send test webhook". Check Railway logs for successful receipt.

---

### Phase 6: Setup Monitoring

**Time:** ~15 minutes

#### Step 6.1: UptimeRobot

1. Go to [uptimerobot.com](https://uptimerobot.com)
2. Dashboard â†’ Add New Monitor
3. **Monitor Type:** HTTPS
4. **Friendly Name:** DryJets API
5. **URL:** `https://your-api-url.railway.app/health`
6. **Monitoring Interval:** 5 minutes (free tier)
7. Click "Create Monitor"

Repeat for each frontend:
- Marketing Admin: `https://dryjets-marketing-admin.vercel.app`
- Platform: `https://dryjets-platform.vercel.app`
- Customer: `https://dryjets-customer.vercel.app`
- Merchant: `https://dryjets-merchant.vercel.app`

**Configure Alerts:**
1. My Settings â†’ Alert Contacts
2. Add your email
3. Add your phone (SMS, free with UptimeRobot)

**âœ… Test:** UptimeRobot will send a test alert. Confirm you receive it.

#### Step 6.2: Sentry Error Tracking

Sentry is already integrated in the code. Just add the DSN:

1. Railway â†’ API Service â†’ Variables
2. Add `SENTRY_DSN` with your DSN from Sentry
3. Save

For frontends:
1. Each Vercel project â†’ Settings â†’ Environment Variables
2. Add `NEXT_PUBLIC_SENTRY_DSN` with your frontend DSN
3. Redeploy

**âœ… Test:** Trigger an error (e.g., visit a non-existent API endpoint). Check Sentry dashboard for the error.

---

## 10 Claude Code Deployment Prompts

These are **ready-to-paste prompts** you can use at any stage of deployment. Copy the entire prompt and paste it into Claude Code.

---

### Prompt 1: Repo Setup Helper

```
You are the DryJets Deployment Assistant.

Task: Verify my local repository is ready for deployment.

Please:
1. Check that I'm in the DryJets directory
2. Verify Node.js version (must be >= 20.0.0)
3. Verify npm version (must be >= 10.0.0)
4. Check if package.json exists at root
5. Verify all apps exist: apps/api, apps/marketing-admin, apps/web-platform, apps/web-customer, apps/web-merchant
6. Verify packages/database/prisma/schema.prisma exists
7. Check if .env.example exists
8. Run npm install at root to install dependencies
9. Generate Prisma client: npx prisma generate --schema=packages/database/prisma/schema.prisma
10. Report any issues found

Output a checklist of âœ… passed or âŒ failed items.
If anything fails, provide exact commands to fix it.
```

---

### Prompt 2: Database Setup Guide

```
You are the DryJets Database Deployment Assistant.

Task: Help me set up the production database on Railway.

Please:
1. Read packages/database/prisma/schema.prisma
2. Count the total number of models
3. List all migrations in packages/database/prisma/migrations/
4. Verify that schema.prisma has database provider set to "postgresql"
5. Generate a production DATABASE_URL template for Railway
6. List all database-related environment variables I need from .env.example
7. Create a checklist for post-database-deployment tasks:
   - Running migrations
   - Verifying connection
   - (Optional) Seeding data

Output:
- Database summary (model count, migration count)
- Environment variables needed
- Step-by-step migration commands for Railway
- Verification commands to test database is working
```

---

### Prompt 3: API Deployment Helper

```
You are the DryJets API Deployment Assistant for Railway.

Task: Guide me through deploying the NestJS API to Railway.

Please:
1. Read apps/api/package.json and confirm build/start scripts
2. Read apps/api/src/main.ts and identify:
   - Port configuration (default port)
   - CORS setup
   - Global prefix for API routes
3. List all environment variables required for the API (from .env.example)
4. Create Railway configuration recommendations:
   - Root directory
   - Build command
   - Start command
   - Watch paths
5. Generate a complete environment variables template for Railway
6. Provide post-deployment verification steps:
   - Test /health endpoint
   - Test /api/docs (Swagger)
   - Test a simple API call

Output:
- Railway build configuration
- Complete .env template with explanations
- Verification commands (curl or browser URLs)
- Troubleshooting tips for common Railway deployment errors
```

---

### Prompt 4: Frontend Deployment Helper

```
You are the DryJets Frontend Deployment Assistant for Vercel.

Task: Guide me through deploying all 4 Next.js apps to Vercel.

Please:
1. List all Next.js apps in apps/ directory
2. For each app, read package.json and identify:
   - App name
   - Build script
   - Start script
   - Development port
3. For each app, read next.config.js (if exists) for any special configuration
4. Generate Vercel deployment config for each app:
   - Project name
   - Root directory
   - Build command
   - Output directory
5. List environment variables needed for each app
6. Create a deployment order (if any dependencies exist)
7. Provide post-deployment verification:
   - Test each frontend URL
   - Test API connectivity from frontend

Output:
- Deployment config for all 4 apps
- Environment variables for each app
- Step-by-step deployment order
- Verification checklist
- How to update CORS on API after getting frontend URLs
```

---

### Prompt 5: CI/CD Setup Prompter

```
You are the DryJets CI/CD Assistant.

Task: Set up GitHub Actions for automated deployment.

Please:
1. Check if .github/workflows/ directory exists
2. Read any existing workflow files (ci.yml, deploy.yml, etc.)
3. Analyze what the current workflows do:
   - Linting
   - Type checking
   - Testing
   - Building
4. Identify gaps in CI/CD:
   - Is deployment automated?
   - Are migrations run automatically?
   - Is there a staging environment workflow?
5. Create recommendations for production deployment workflow:
   - Trigger: Push to main branch
   - Jobs: test â†’ build â†’ deploy
   - Secrets needed (Railway token, Vercel token, etc.)
6. Provide instructions on how to add secrets to GitHub:
   - Repository â†’ Settings â†’ Secrets and variables â†’ Actions

Output:
- Current CI/CD status report
- Recommended workflow improvements
- Step-by-step guide to add deployment automation
- GitHub Secrets checklist
- (Optional) Generate a new workflow file if needed
```

---

### Prompt 6: Health Check & Debug

```
You are the DryJets Health Check & Debugging Assistant.

Task: Test all deployed endpoints and identify issues.

Please:
1. Ask me for:
   - API URL (Railway)
   - Marketing Admin URL (Vercel)
   - Web Platform URL (Vercel)
   - Web Customer URL (Vercel)
   - Web Merchant URL (Vercel)

2. For the API, test these endpoints:
   - GET /health (should return 200 OK)
   - GET /api/docs (should return Swagger UI)
   - GET /api/v1/users (might return 401, but should not be 500)

3. For each frontend, test:
   - Homepage loads (200 OK)
   - Can fetch from API (check browser console for CORS errors)

4. Analyze Railway logs (I'll paste them):
   - Look for errors
   - Look for missing environment variables
   - Look for database connection issues
   - Look for port conflicts

5. Common issues to check:
   - DATABASE_URL format
   - CORS_ORIGIN matches frontend URLs
   - Prisma Client generated
   - Migrations run successfully

Output:
- Health check results (âœ… or âŒ for each endpoint)
- List of errors found
- Root cause analysis
- Step-by-step fix instructions
```

---

### Prompt 7: Monitoring & Alerts Setup

```
You are the DryJets Monitoring Assistant.

Task: Set up comprehensive monitoring for production.

Please:
1. Create a monitoring checklist:
   - [ ] Uptime monitoring (UptimeRobot)
   - [ ] Error tracking (Sentry)
   - [ ] Performance monitoring
   - [ ] Database performance
   - [ ] Cost monitoring (Railway, Vercel)

2. For UptimeRobot:
   - List all URLs to monitor
   - Recommended check intervals
   - Alert channels (email, SMS, Slack)

3. For Sentry:
   - Verify SENTRY_DSN is set in all apps
   - Test error reporting (how to trigger a test error)
   - Set up alerts (critical errors only)

4. For Railway:
   - How to read logs
   - How to set up usage alerts
   - How to monitor database connections

5. For Vercel:
   - How to access analytics
   - How to monitor build times
   - How to set up budget alerts

Output:
- Monitoring setup checklist
- Step-by-step UptimeRobot configuration
- Sentry integration verification
- Log analysis guide (Railway + Vercel)
- Alert configuration recommendations
```

---

### Prompt 8: Security Review & Hardening

```
You are the DryJets Security Hardening Assistant.

Task: Audit the deployment for security issues and harden it.

Please:
1. Scan the codebase for common security issues:
   - Exposed secrets (.env committed?)
   - Hardcoded API keys
   - SQL injection vulnerabilities (check Prisma usage)
   - XSS vulnerabilities (check React components)

2. Check Railway environment variables:
   - Are production secrets different from development?
   - Is JWT_SECRET strong (>= 32 chars)?
   - Are API keys in test mode or live mode?

3. Check API security:
   - Is CORS properly configured?
   - Are there rate limits? (check for @nestjs/throttler)
   - Is input validation enabled? (check for ValidationPipe)
   - Are security headers set? (check for helmet)

4. Check database security:
   - Is DATABASE_URL using SSL? (should have ?sslmode=require)
   - Are there indexes on frequently queried fields?
   - Is connection pooling configured?

5. Check frontend security:
   - Are API keys client-side only for appropriate services?
   - Is Content Security Policy (CSP) configured?
   - Are dependencies up to date? (npm audit)

Output:
- Security audit report
- List of vulnerabilities found (severity: critical/high/medium/low)
- Step-by-step remediation guide
- Security best practices checklist
- Commands to run (npm audit fix, etc.)
```

---

### Prompt 9: Post-Deployment Validator

```
You are the DryJets Post-Deployment Validation Assistant.

Task: Run comprehensive tests to ensure everything is working in production.

Please:
1. Test Core Functionality:
   - [ ] User registration works
   - [ ] User login works
   - [ ] JWT tokens are issued
   - [ ] Database reads/writes work
   - [ ] Redis caching works
   - [ ] File uploads work (S3/R2)

2. Test Integrations:
   - [ ] Stripe test payment
   - [ ] SendGrid email sending
   - [ ] Twilio SMS sending
   - [ ] Google Maps API

3. Test Marketing Engine:
   - [ ] Campaign creation
   - [ ] Content generation (if AI keys are set)
   - [ ] Trend analysis
   - [ ] Analytics dashboard

4. Test Offer-Lab (if applicable):
   - [ ] Offer import
   - [ ] Funnel generation
   - [ ] Traffic deployment

5. Performance Tests:
   - [ ] API response time < 500ms
   - [ ] Frontend load time < 3s
   - [ ] Database query time < 100ms

6. Error Handling:
   - [ ] 404 pages render correctly
   - [ ] 500 errors are caught by Sentry
   - [ ] Validation errors return 400

After testing, generate a comprehensive report:
/docs/17-guides/PRODUCTION_VERIFICATION_LOG.md

Include:
- Timestamp of tests
- All endpoints tested
- Pass/fail status
- Performance metrics
- Issues found
- Recommended next steps
```

---

### Prompt 10: Rollback & Backup Assistant

```
You are the DryJets Rollback & Disaster Recovery Assistant.

Task: Set up backup and rollback procedures.

Please:
1. Database Backups:
   - How to enable automatic backups in Railway
   - How to manually create a backup
   - How to restore from backup
   - Backup retention policy (how long to keep)

2. Code Rollbacks:
   - How to rollback Railway deployment (previous build)
   - How to rollback Vercel deployment (previous deployment)
   - How to rollback database migrations (prisma migrate rollback?)

3. Disaster Recovery Plan:
   - If database is corrupted, how to restore
   - If API crashes, how to redeploy
   - If frontends are down, how to redeploy
   - If environment variables are lost, where are backups?

4. Create backup procedures:
   - Weekly database export (pg_dump)
   - Weekly .env.production backup (encrypted)
   - Weekly code snapshot (git tag)

5. Testing Recovery:
   - Create a test backup
   - Simulate a failure (delete a test record)
   - Restore from backup
   - Verify data integrity

Output:
- Backup setup guide
- Rollback procedures (step-by-step for each service)
- Disaster recovery runbook
- Weekly backup automation script
- Contact list for emergencies (Railway support, Vercel support, etc.)
```

---

## Post-Deployment Validation

### Automated Testing Checklist

After deployment, run through this checklist:

#### API Health Checks

```bash
# Replace YOUR_API_URL with your actual Railway URL

# 1. Health Check
curl https://YOUR_API_URL.railway.app/health

# Expected: {"status":"ok"}

# 2. Swagger Docs
curl https://YOUR_API_URL.railway.app/api/docs

# Expected: HTML page with Swagger UI

# 3. Test Authentication
curl -X POST https://YOUR_API_URL.railway.app/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "TestPassword123!",
    "role": "CUSTOMER"
  }'

# Expected: User created or "User already exists"
```

#### Frontend Health Checks

Visit each URL in your browser:

1. **Marketing Admin:** `https://dryjets-marketing-admin.vercel.app`
   - [ ] Page loads without errors
   - [ ] Can see dashboard
   - [ ] API calls work (check browser console)

2. **Web Platform:** `https://dryjets-platform.vercel.app`
   - [ ] Homepage loads
   - [ ] Navigation works
   - [ ] Can authenticate

3. **Web Customer:** `https://dryjets-customer.vercel.app`
   - [ ] Can browse services
   - [ ] Can add items to cart
   - [ ] Maps load (Google Maps)

4. **Web Merchant:** `https://dryjets-merchant.vercel.app`
   - [ ] Dashboard loads
   - [ ] Can view orders
   - [ ] Can update order status

#### Database Validation

```bash
# Connect to Railway PostgreSQL
# Get connection string from Railway Variables

# Count users
psql $DATABASE_URL -c "SELECT COUNT(*) FROM \"User\";"

# List tables
psql $DATABASE_URL -c "\dt"

# Check migrations
psql $DATABASE_URL -c "SELECT * FROM \"_prisma_migrations\";"
```

#### Integration Tests

**Stripe Payment:**
1. Go to customer portal
2. Add an item
3. Checkout with test card: `4242 4242 4242 4242`
4. Verify payment succeeds
5. Check Stripe dashboard for payment

**SendGrid Email:**
1. Trigger a password reset
2. Check SendGrid activity log
3. Verify email was sent

**Twilio SMS:**
1. Trigger an OTP send
2. Check Twilio console logs
3. Verify SMS was sent

**Google Maps:**
1. Go to customer portal
2. Search for an address
3. Verify map loads and geocoding works

---

## Troubleshooting Guide

### Common Deployment Issues

#### Issue 1: Railway Build Fails - "Cannot find module '@prisma/client'"

**Cause:** Prisma client not generated during build.

**Fix:**
1. Railway â†’ API Service â†’ Settings
2. Update Build Command to:
   ```bash
   npm install && npx prisma generate --schema=../../packages/database/prisma/schema.prisma && npm run build
   ```
3. Redeploy

---

#### Issue 2: API Returns 500 - "PrismaClient is unable to connect to the database"

**Cause:** DATABASE_URL is incorrect or database is not accessible.

**Fix:**
1. Railway â†’ PostgreSQL service â†’ Variables
2. Verify `DATABASE_URL` format:
   ```
   postgresql://postgres:password@host.railway.app:5432/railway
   ```
3. Copy the exact URL
4. Railway â†’ API Service â†’ Variables
5. Update `DATABASE_URL` with the copied value
6. Redeploy

**Alternative Fix:** Check if PostgreSQL service is running:
- Railway â†’ PostgreSQL service â†’ Deployments
- Should show "Active"

---

#### Issue 3: Frontend Shows "Failed to Fetch" Error

**Cause:** CORS error - API is blocking requests from frontend.

**Fix:**
1. Open browser console (F12)
2. Look for error like: `Access to fetch at 'https://api...' from origin 'https://app...' has been blocked by CORS policy`
3. Railway â†’ API Service â†’ Variables
4. Find `CORS_ORIGIN`
5. Update to include your frontend URLs (comma-separated):
   ```
   https://dryjets-marketing-admin.vercel.app,https://dryjets-platform.vercel.app,https://dryjets-customer.vercel.app,https://dryjets-merchant.vercel.app
   ```
6. Save and redeploy

---

#### Issue 4: Railway Build Fails - "EACCES: permission denied"

**Cause:** Railway trying to write to a read-only directory.

**Fix:**
1. Check your package.json scripts
2. Ensure no scripts write to `node_modules/` or system directories
3. If you have a `postinstall` script, verify it only writes to allowed directories

**Common culprit:** Prisma generate trying to write to wrong location.

**Fix:**
```json
{
  "scripts": {
    "postinstall": "cd packages/database && npx prisma generate"
  }
}
```

Change to:
```json
{
  "scripts": {
    "postinstall": "npx prisma generate --schema=packages/database/prisma/schema.prisma"
  }
}
```

---

#### Issue 5: Vercel Build Fails - "Module not found"

**Cause:** Vercel can't resolve imports from shared packages.

**Fix:**
1. Vercel â†’ Project â†’ Settings â†’ General
2. Check "Root Directory" is correct (e.g., `apps/marketing-admin`)
3. Check "Framework Preset" is "Next.js"
4. Settings â†’ Build & Development Settings
5. **Install Command:** Change to:
   ```bash
   cd ../.. && npm install && cd -
   ```
   This installs dependencies from monorepo root.

---

#### Issue 6: Database Migration Fails - "Unique constraint violation"

**Cause:** Trying to run migrations on a database that already has data.

**Fix:**
1. If this is a fresh deployment, reset the database:
   ```bash
   # Connect to Railway shell
   npx prisma migrate reset --schema=../../packages/database/prisma/schema.prisma
   ```
2. Then run:
   ```bash
   npx prisma migrate deploy --schema=../../packages/database/prisma/schema.prisma
   ```

**Alternative:** If you have production data, create a new migration:
```bash
# Locally
npx prisma migrate dev --name fix_constraints --schema=packages/database/prisma/schema.prisma

# Push to GitHub
git add .
git commit -m "fix: database migration constraints"
git push

# Railway will auto-deploy
```

---

#### Issue 7: SendGrid Emails Not Sending

**Cause:** Sender email not verified or API key incorrect.

**Fix:**
1. SendGrid â†’ Settings â†’ Sender Authentication
2. Verify your sender email or domain
3. Check API key:
   - Settings â†’ API Keys
   - Verify key has "Mail Send" permissions
4. Railway â†’ API Service â†’ Variables
5. Update `SENDGRID_API_KEY` and `SENDGRID_FROM_EMAIL`
6. Test:
   ```bash
   curl -X POST https://YOUR_API_URL/api/v1/auth/forgot-password \
     -H "Content-Type: application/json" \
     -d '{"email": "test@example.com"}'
   ```

---

#### Issue 8: Stripe Webhooks Not Working

**Cause:** Webhook URL incorrect or signing secret wrong.

**Fix:**
1. Stripe Dashboard â†’ Developers â†’ Webhooks
2. Click on your webhook
3. Verify URL is: `https://YOUR_API_URL.railway.app/api/v1/payments/webhook`
4. Reveal signing secret
5. Railway â†’ API Service â†’ Variables
6. Update `STRIPE_WEBHOOK_SECRET`
7. Test:
   - Stripe Dashboard â†’ Your webhook â†’ "Send test webhook"
   - Check Railway logs for "Webhook received"

---

#### Issue 9: High Railway Costs

**Cause:** App using too many resources or not sleeping.

**Fix:**
1. Railway â†’ API Service â†’ Metrics
2. Check CPU and memory usage
3. If high, optimize:
   - Add caching (Redis)
   - Optimize database queries (add indexes)
   - Reduce memory usage (increase connection pool)
4. Enable auto-sleep:
   - Railway â†’ Settings â†’ Auto-Sleep
   - Enable for non-production services

**Cost monitoring:**
- Railway â†’ Project â†’ Usage
- Set budget alerts

---

#### Issue 10: Slow API Response Times

**Cause:** Database queries not optimized or missing indexes.

**Fix:**
1. Enable query logging:
   ```typescript
   // apps/api/src/main.ts
   const prisma = new PrismaClient({
     log: ['query', 'info', 'warn', 'error'],
   });
   ```
2. Check Railway logs for slow queries
3. Add indexes to schema.prisma:
   ```prisma
   model User {
     id    String @id @default(cuid())
     email String @unique

     @@index([email]) // Add index
   }
   ```
4. Run migration:
   ```bash
   npx prisma migrate dev --name add_indexes
   ```

---

### Error Code Reference

| Error Code | Meaning | Common Cause | Fix |
|------------|---------|--------------|-----|
| 500 | Internal Server Error | Database connection failed | Check DATABASE_URL |
| 502 | Bad Gateway | API is down | Check Railway deployment status |
| 503 | Service Unavailable | API is starting | Wait 30 seconds and retry |
| 400 | Bad Request | Invalid input | Check request body matches DTO |
| 401 | Unauthorized | Missing or invalid JWT | Login again |
| 403 | Forbidden | Insufficient permissions | Check user role |
| 404 | Not Found | Endpoint doesn't exist | Check API URL and route |
| 429 | Too Many Requests | Rate limit exceeded | Wait and retry |
| CORS Error | Cross-Origin Request Blocked | CORS not configured | Update CORS_ORIGIN |

---

## Long-Term Stability & Monitoring

### Weekly Maintenance Tasks

**Every Monday:**
- [ ] Check UptimeRobot for any downtime alerts
- [ ] Review Sentry errors (critical ones only)
- [ ] Check Railway usage (avoid surprise bills)
- [ ] Review Vercel analytics (traffic, performance)
- [ ] Verify backups completed successfully

**Every Month:**
- [ ] Update dependencies (`npm outdated` â†’ `npm update`)
- [ ] Review security advisories (`npm audit`)
- [ ] Check database size (scale if needed)
- [ ] Review and optimize slow queries
- [ ] Test disaster recovery (restore from backup)

---

### Automated Backups

#### Database Backups (Railway)

Railway includes automatic daily backups. To verify:
1. Railway â†’ PostgreSQL service â†’ Settings
2. Backups should show "Enabled"

**Manual backup:**
```bash
# Get DATABASE_URL from Railway
export DATABASE_URL="postgresql://..."

# Backup to file
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql

# Upload to secure storage (e.g., S3)
aws s3 cp backup_$(date +%Y%m%d).sql s3://your-backup-bucket/
```

#### Environment Variables Backup

**CRITICAL:** Store your environment variables securely.

1. Railway â†’ API Service â†’ Variables â†’ Download
2. Save as `production.env` (encrypted!)
3. Store in password manager (1Password, LastPass)
4. Or commit encrypted version:
   ```bash
   # Encrypt
   gpg --symmetric --cipher-algo AES256 production.env

   # Commit encrypted file
   git add production.env.gpg
   git commit -m "backup: encrypted production env vars"
   ```

#### Weekly Automated Backup Script

Create `.github/workflows/weekly-backup.yml`:

```yaml
name: Weekly Backup

on:
  schedule:
    - cron: '0 2 * * 1' # Every Monday at 2 AM

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Backup Database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          pg_dump $DATABASE_URL > backup.sql

      - name: Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws s3 cp backup.sql s3://dryjets-backups/$(date +%Y%m%d).sql

      - name: Notify on Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Weekly backup failed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

---

### Scaling Strategy

**When to scale:**
- API response time > 1 second
- Database CPU > 80%
- Memory usage > 90%
- More than 10,000 users

**How to scale on Railway:**

**Vertical Scaling (bigger machine):**
1. Railway â†’ API Service â†’ Settings
2. Resources â†’ Increase memory/CPU
3. Note: Costs increase

**Horizontal Scaling (more instances):**
1. Railway â†’ API Service â†’ Settings
2. Deployments â†’ Scale to N replicas
3. Railway adds load balancer automatically

**Database Scaling:**
1. Railway â†’ PostgreSQL â†’ Settings
2. Add read replicas (for read-heavy apps)
3. Or migrate to dedicated database (e.g., AWS RDS)

---

### Monitoring Alerts

**Set up alerts for:**
1. **Downtime** (UptimeRobot)
   - Alert if down for > 5 minutes
   - Send email + SMS

2. **Errors** (Sentry)
   - Alert on critical errors only
   - Send email to dev team

3. **Performance** (Railway)
   - Alert if CPU > 80% for 10 minutes
   - Alert if memory > 90%

4. **Costs** (Railway + Vercel)
   - Alert if usage > $50/month (Railway)
   - Alert if bandwidth > 80% (Vercel)

**How to set up cost alerts:**
- Railway: Settings â†’ Billing â†’ Usage Alerts
- Vercel: Settings â†’ Billing â†’ Usage Alerts

---

## Cost Calculator

### Free Tier Limits

| Service | Free Tier | When You'll Exceed |
|---------|-----------|-------------------|
| **Vercel** | 100GB bandwidth/month | ~5,000 daily visitors |
| **Railway** | $5 credit/month | ~500 API requests/hour sustained |
| **Cloudflare R2** | 10GB storage | ~10,000 uploaded images |
| **SendGrid** | 100 emails/day | ~3,000 users (if 1 email/user/month) |
| **Twilio** | Trial credit ($15) | ~100 SMS messages |
| **UptimeRobot** | 50 monitors | Never (you only need 5) |
| **Sentry** | 5,000 errors/month | If your app is very buggy |

### Estimated Monthly Costs

**Scenario 1: MVP / Low Traffic (0-1,000 users)**
- Vercel: **$0** (within free tier)
- Railway: **$0** (within $5 credit)
- Cloudflare R2: **$0** (within free tier)
- SendGrid: **$0** (within free tier)
- Twilio: **$20/month** (after trial)
- **Total: ~$20/month**

**Scenario 2: Growing (1,000-10,000 users)**
- Vercel: **$20/month** (Pro plan for better performance)
- Railway: **$25/month** ($5 free + $20 overage)
- Cloudflare R2: **$0.15/GB** (if over 10GB)
- SendGrid: **$20/month** (Essentials plan)
- Twilio: **$50/month**
- **Total: ~$115/month**

**Scenario 3: Scaled (10,000-100,000 users)**
- Vercel: **$150/month** (Team plan)
- Railway: **$100/month** (more resources)
- Cloudflare R2: **$5/month**
- SendGrid: **$90/month** (Pro plan)
- Twilio: **$200/month**
- AWS RDS: **$100/month** (migrate from Railway)
- **Total: ~$645/month**

**Break-even analysis:**
- At ~5,000 users, you should be generating revenue
- At ~10,000 users, infrastructure costs ~$115/month
- If charging $10/user/month, revenue = $100,000/month
- Infrastructure is <0.2% of revenue

---

## Glossary

**Terms for Beginners:**

- **API (Application Programming Interface):** The backend that frontends talk to. Like a waiter taking orders from customers (frontends) to the kitchen (database).

- **CDN (Content Delivery Network):** Servers around the world that cache your app so it loads faster globally.

- **CORS (Cross-Origin Resource Sharing):** Security feature that controls which websites can talk to your API.

- **Database Migration:** A version-controlled way to change your database structure (add tables, columns, etc.).

- **DSN (Data Source Name):** A connection string that tells your app how to connect to a service (e.g., Sentry, database).

- **Environment Variable:** A configuration setting (like a password or URL) that changes between development and production.

- **JWT (JSON Web Token):** A secure way to authenticate users without sessions. Like a concert wristband that proves you paid.

- **Monorepo:** One big repository containing multiple apps and shared code.

- **ORM (Object-Relational Mapping):** A tool (like Prisma) that lets you talk to databases using JavaScript instead of SQL.

- **Prisma Client:** Auto-generated code that lets you query your database with type-safety.

- **Redis:** A super-fast in-memory database used for caching and sessions.

- **Serverless:** Apps that run on-demand without managing servers (like Vercel, Railway).

- **SSL/TLS Certificate:** The "lock" icon in your browser that means the connection is encrypted.

- **Webhook:** A way for one service (e.g., Stripe) to automatically notify your app when something happens (e.g., payment received).

---

## Next Steps

### After Successful Deployment

1. **Add Custom Domain** (optional)
   - Buy domain from Namecheap, Google Domains, etc.
   - Follow "Phase 4: Setup Custom Domains"

2. **Enable Production Mode** (Stripe, AI services)
   - Switch Stripe from test mode to live mode
   - Update API keys in Railway

3. **Add Analytics**
   - Google Analytics
   - Mixpanel
   - PostHog

4. **Set Up Email Campaigns**
   - SendGrid Marketing Campaigns
   - Or integrate Mailchimp

5. **Add More Features**
   - Use the Marketing Engine for campaigns
   - Set up Offer-Lab for affiliate marketing
   - Enable IoT equipment tracking

6. **Invite Team Members**
   - Railway: Settings â†’ Members
   - Vercel: Settings â†’ Members
   - GitHub: Settings â†’ Collaborators

7. **Set Up Staging Environment**
   - Create separate Railway project for staging
   - Create separate Vercel projects for staging
   - Test changes before production

---

## Support & Resources

### Official Documentation
- [Vercel Docs](https://vercel.com/docs)
- [Railway Docs](https://docs.railway.app)
- [Prisma Docs](https://www.prisma.io/docs)
- [NestJS Docs](https://docs.nestjs.com)
- [Next.js Docs](https://nextjs.org/docs)

### Community Support
- [DryJets GitHub Issues](https://github.com/YOUR_USERNAME/DryJets/issues)
- [Railway Discord](https://discord.gg/railway)
- [Vercel Discord](https://vercel.com/discord)

### Emergency Contacts
- **Railway Support:** support@railway.app
- **Vercel Support:** support@vercel.com
- **Stripe Support:** support@stripe.com

---

## Conclusion

**Congratulations!** ðŸŽ‰

If you followed this guide, you now have:
- âœ… A fully deployed production system
- âœ… 4 frontend apps live on Vercel
- âœ… 1 backend API live on Railway
- âœ… PostgreSQL database with 103 models
- âœ… Redis for caching and sessions
- âœ… File storage with Cloudflare R2 or AWS S3
- âœ… Payment processing with Stripe
- âœ… Email and SMS notifications
- âœ… Monitoring and error tracking
- âœ… Automated backups
- âœ… SSL certificates (HTTPS)
- âœ… CI/CD with GitHub Actions

**Total time:** ~2-3 hours
**Total cost:** $0-20/month (for MVP)

**What's next?**
- Launch to real users
- Gather feedback
- Iterate on features
- Scale as you grow

---

**Generated by Claude Code**
**Last Updated:** 2025-11-01
**Version:** 1.0.0

For questions or issues, use **Prompt 6: Health Check & Debug** to troubleshoot any problems.
